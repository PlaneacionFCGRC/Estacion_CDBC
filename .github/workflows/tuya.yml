name: Tuya Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'

jobs:
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install requests

      - name: Fetch and Save Tuya Data
        env:
          CLIENT_ID: ${{ secrets.TUYA_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.TUYA_CLIENT_SECRET }}
        run: |
          python - <<EOF
          import requests, time, hashlib, hmac, csv, os
          from datetime import datetime

          client_id = "${CLIENT_ID}"
          secret = "${CLIENT_SECRET}"
          endpoint = "https://openapi.tuyaus.com"
          device_id = "ebdfd6827dd4b8baadoxvu"

          def sha256(body=""):
              return hashlib.sha256(body.encode()).hexdigest()

          def get_sign(method, path, timestamp, access_token=""):
              string_to_sign = method + "\\n" + sha256("") + "\\n\\n" + path
              message = client_id + access_token + timestamp + string_to_sign
              return hmac.new(secret.encode(), message.encode(), hashlib.sha256).hexdigest().upper()

          # TOKEN
          path = "/v1.0/token?grant_type=1"
          t = str(int(time.time()*1000))
          sign = get_sign("GET", path, t)

          headers = {"client_id":client_id,"t":t,"sign_method":"HMAC-SHA256","sign":sign}
          token = requests.get(endpoint+path, headers=headers).json()

          if not token.get("success"):
              print("ERROR TOKEN:", token)
              exit(1)

          access_token = token["result"]["access_token"]

          # DEVICE DATA
          path2 = f"/v2.0/cloud/thing/{device_id}/shadow/properties"
          t2 = str(int(time.time()*1000))
          sign2 = get_sign("GET", path2, t2, access_token)

          headers2 = {
              "client_id":client_id,
              "access_token":access_token,
              "t":t2,
              "sign_method":"HMAC-SHA256",
              "sign":sign2
          }

          device = requests.get(endpoint+path2, headers=headers2).json()

          if not device.get("success"):
              print("ERROR DEVICE:", device)
              exit(1)

          props = {p["code"]:p["value"] for p in device["result"]["properties"]}

          fila = {
              "fecha": datetime.utcnow(),
              "temp_int": props.get("temp_current",0)/10,
              "hum_int": props.get("humidity_value",0),
              "temp_ext": props.get("temp_current_external",0)/10,
              "hum_ext": props.get("humidity_outdoor",0),
              "uv": props.get("uv_index",0),
              "lluvia_24h": props.get("rain_24h",0)
          }

          archivo="datos.csv"
          existe=os.path.isfile(archivo)

          with open(archivo,"a",newline="") as f:
              writer=csv.DictWriter(f,fieldnames=fila.keys())
              if not existe:
                  writer.writeheader()
              writer.writerow(fila)

          print("Fila guardada:",fila)
          EOF

      - name: Commit CSV
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add datos.csv
          git commit -m "Datos estaciÃ³n actualizados" || echo "Sin cambios"
          git push
          Add tuya workflow
